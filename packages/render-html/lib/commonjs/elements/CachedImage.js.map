{"version":3,"sources":["CachedImage.tsx"],"names":["SHA1","require","s4","Math","floor","random","toString","substring","BASE_DIR","RNFetchBlob","fs","dirs","CacheDir","FILE_PREFIX","Platform","OS","ImageCache","getPath","uri","immutable","path","lastIndexOf","indexOf","ext","constructor","get","instance","clear","cache","unlink","on","source","handler","downloading","handlers","undefined","push","getCachedImagePath","dispose","forEach","h","index","splice","bust","cancel","task","download","method","config","fetch","headers","then","resp","respInfo","status","authorizationError","notify","catch","exists","BaseCachedImage","Component","props","onError","nativeEvent","error","Error","currentTarget","target","bubbles","cancelable","defaultPrevented","eventPhase","isTrusted","preventDefault","isDefaultPrevented","stopPropagation","isPropagationStopped","persist","timeStamp","type","setState","key","observe","mutable","getProps","Object","keys","prop","state","checkSource","Array","isArray","componentWillMount","componentWillReceiveProps","nextProps","componentWillUnmount","CachedImage","render","ownProps","React","Children","count","children","console","warn","CachedImageBackground","CustomCachedImage","component"],"mappings":"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","sourcesContent":["import React, {Component} from \"react\";\nimport {Image, ImageBackground, ImageProperties, ImageURISource, Platform, ViewStyle} from \"react-native\";\nimport RNFetchBlob from 'react-native-fetch-blob';\nimport { ImageDimensions } from \"..\";\nconst SHA1 = require(\"crypto-js/sha1\");\nimport IMGElementContentAlt from './IMGElementContentAlt';\n\nconst s4 = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\nconst BASE_DIR = RNFetchBlob.fs.dirs.CacheDir + \"/react-native-img-cache\";\nconst FILE_PREFIX = Platform.OS === \"ios\" ? \"\" : \"file://\";\nexport type CacheHandler = (path: string) => void;\n\nexport interface CachedImageURISource extends ImageURISource {\n    uri: string;\n}\n\ntype CacheEntry = {\n    source: CachedImageURISource;\n    downloading: boolean;\n    handlers: CacheHandler[];\n    path: string | undefined;\n    immutable: boolean | true;\n    authorizationError?: boolean | false;\n    task?: any;\n};\n\nexport class ImageCache {\n\n    private getPath(uri: string, immutable?: boolean): string {\n        let path = uri.substring(uri.lastIndexOf(\"/\"));\n        path = path.indexOf(\"?\") === -1 ? path : path.substring(path.lastIndexOf(\".\"), path.indexOf(\"?\"));\n        const ext = path.indexOf(\".\") === -1 ? \".jpg\" : path.substring(path.indexOf(\".\"));\n        if (immutable === true) {\n            return BASE_DIR + \"/\" + SHA1(uri) + ext;\n        } else {\n            return BASE_DIR + \"/\" + s4() + s4() + \"-\" + s4() + \"-\" + s4() + \"-\" + s4() + \"-\" + s4() + s4() + s4() + ext;\n        }\n    }\n\n    private static instance: ImageCache;\n\n    private constructor() {}\n\n    static get(): ImageCache {\n        if (!ImageCache.instance) {\n            ImageCache.instance = new ImageCache();\n        }\n        return ImageCache.instance;\n    }\n\n    private cache: { [uri: string]: CacheEntry } = {};\n\n    clear() {\n        this.cache = {};\n        return RNFetchBlob.fs.unlink(BASE_DIR);\n    }\n\n    on(source: CachedImageURISource, handler: CacheHandler, immutable: boolean = true) {\n        const {uri} = source;\n        if (!this.cache[uri]) {\n            this.cache[uri] = {\n                source,\n                downloading: false,\n                handlers:[],\n                immutable: immutable === true,\n                path: immutable === true ? this.getPath(uri, immutable) : undefined\n            };\n            if (handler) {\n                this.cache[uri].handlers = [handler];\n            }\n        } else {\n            handler && this.cache[uri].handlers.push(handler);\n        }\n        this.get(uri);\n    }\n\n    getCachedImagePath(uri: string) {\n        return this.cache[uri];\n    }\n\n    dispose(uri: string, handler: CacheHandler) {\n        const cache = this.cache[uri];\n        if (cache && cache.handlers) {\n            cache.handlers.forEach((h, index) => {\n                if (h === handler) {\n                    cache.handlers.splice(index, 1);\n                }\n            });\n        }\n    }\n\n    bust(uri: string) {\n        const cache = this.cache[uri];\n        if (cache !== undefined && !cache.immutable) {\n            cache.path = undefined;\n            this.get(uri);\n        }\n    }\n\n    cancel(uri: string) {\n        const cache = this.cache[uri];\n        if (cache && cache.downloading) {\n            cache.task.cancel();\n        }\n    }\n\n    private download(cache: CacheEntry) {\n        const {source} = cache;\n        const {uri} = source;\n        if (!cache.downloading) {\n            const path = this.getPath(uri, cache.immutable);\n            cache.downloading = true;\n            const method = source.method ? source.method : \"GET\";\n            cache.task = RNFetchBlob.config({ path }).fetch(method, uri, source.headers);\n            cache.task.then((resp: any) => {\n                if (resp.respInfo.status == 401) {\n                    // Unauthorized\n                    this.cache[uri].path = undefined;\n                    cache.downloading = false;\n                    cache.authorizationError = true;\n                    RNFetchBlob.fs.unlink(path);\n                    this.notify(uri);\n                }\n                else {\n                    cache.downloading = false;\n                    cache.path = path;\n                    this.notify(uri);\n                }\n            }).catch(() => {\n                cache.downloading = false;\n                RNFetchBlob.fs.unlink(path);\n            });\n        }\n    }\n\n    private get(uri: string) {\n        const cache = this.cache[uri];\n        if (cache.path) {\n            // We check here if IOS didn't delete the cache content\n            RNFetchBlob.fs.exists(cache.path).then((exists: boolean) => {\n                if (exists) {\n                    this.notify(uri);\n                } else {\n                    this.download(cache);\n                }\n            });\n        } else {\n            this.download(cache);\n        }\n\n    }\n\n    private notify(uri: string) {\n        const handlers = this.cache[uri].handlers;\n        handlers && handlers.forEach(handler => {\n            handler(this.cache[uri].path as string);\n        });\n    }\n}\n\nexport interface CachedImageProps extends ImageProperties {\n    mutable?: boolean;\n    alt?: string;\n    altColor?: string;\n    containerStyle: ViewStyle;\n    dimensions: ImageDimensions;\n}\n\nexport interface CustomCachedImageProps extends CachedImageProps {\n    component: new () => Component<any, any>;\n}\n\nexport interface CachedImageState {\n    path: string | undefined;\n    error: boolean | false;\n    key: number | -1;\n}\n\nexport abstract class BaseCachedImage<P extends CachedImageProps> extends Component<P, CachedImageState>  {\n\n    private uri: string | undefined;\n\n    private handler: CacheHandler = (path: string) => {\n        if (path === undefined) {\n            this.props.onError && this.props.onError({\n                nativeEvent: { error: new Error(\"unauthorized\") },\n                currentTarget: 1,\n                target: 1,\n                bubbles: false,\n                cancelable: false,\n                defaultPrevented: false,\n                eventPhase: 0,\n                isTrusted: false,\n                preventDefault: function (): void {\n                    \n                },\n                isDefaultPrevented: function (): boolean {\n                    return false;\n                },\n                stopPropagation: function (): void {\n                    \n                },\n                isPropagationStopped: function (): boolean {\n                    return false;\n                },\n                persist: function (): void {\n                },\n                timeStamp: 0,\n                type: \"\"\n            });\n            this.setState({ error: true, key: Math.random() });\n        }\n        else {\n            this.setState({ path, error: false, key: Math.random() });\n        }\n    }\n\n    private dispose() {\n        if (this.uri) {\n            ImageCache.get().dispose(this.uri, this.handler);\n        }\n    }\n\n    private observe(source: CachedImageURISource, mutable: boolean) {\n        if (source.uri !== this.uri) {\n            this.dispose();\n            this.uri = source.uri;\n            ImageCache.get().on(source, this.handler, !mutable);\n        }\n    }\n\n    protected getProps() {\n        const props: any = {};\n        Object.keys(this.props).forEach(prop => {\n            if (prop === \"source\" && (this.props as any).source.uri) {\n                props[\"source\"] = this.state.path ? {uri: FILE_PREFIX + this.state.path} : {};\n            } else if ([\"mutable\", \"component\"].indexOf(prop) === -1) {\n                props[prop] = (this.props as any)[prop];\n            }\n        });\n        return props;\n    }\n\n\n    private checkSource(source: number | ImageURISource | ImageURISource[]): ImageURISource | number {\n        if (Array.isArray(source)) {\n            throw new Error(`Giving multiple URIs to CachedImage is not yet supported.\n            If you want to see this feature supported, please file and issue at\n             https://github.com/wcandillon/react-native-img-cache`);\n        }\n        return source;\n    }\n\n    componentWillMount() {\n        const {mutable} = this.props;\n        const source = this.checkSource(this.props.source);\n        this.setState({ path: undefined });\n        if (typeof(source) !== \"number\" && source.uri) {\n            this.observe(source as CachedImageURISource, mutable === true);\n        }\n    }\n\n    componentWillReceiveProps(nextProps: P) {\n        const {mutable} = nextProps;\n        const source = this.checkSource(nextProps.source);\n        if (typeof(source) !== \"number\" && source.uri) {\n            this.observe(source as CachedImageURISource, mutable === true);\n        }\n    }\n\n    componentWillUnmount() {\n        this.dispose();\n    }\n}\n\nexport class CachedImage extends BaseCachedImage<CachedImageProps> {\n\n    render() {\n        const props = this.getProps();\n        const { error, key } = this.state;\n        const ownProps = this.props;\n        if (error) {\n            return (\n                <IMGElementContentAlt {...ownProps} source={{uri:''}} testID=\"image-error\" />\n            );\n        }\n        if (React.Children.count(this.props.children) > 0) {\n            console.warn(\"Using <CachedImage> with children is deprecated, use <CachedImageBackground> instead.\");\n        }\n        return <Image {...props}  key = {key}>{this.props.children}</Image>;\n    }\n}\n\nexport class CachedImageBackground extends BaseCachedImage<CachedImageProps> {\n\n    render() {\n        const props = this.getProps();\n        return <ImageBackground {...props}>{this.props.children}</ImageBackground>;\n    }\n}\n\nexport class CustomCachedImage<P extends CustomCachedImageProps> extends BaseCachedImage<P> {\n\n    render() {\n        const {component} = this.props;\n        const props = this.getProps();\n        const Component = component;\n        return <Component {...props}>{this.props.children}</Component>;\n    }\n}"]}